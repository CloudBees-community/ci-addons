#set -eu
umask 077
unset PGVERSION
PGVERSION=${PGVERSION:-9.0.7}
ARCH=`uname -m`
PGNAME=postgresql-${PGVERSION}-${ARCH}

cd /tmp
wget --continue http://ftp.postgresql.org/pub/source/v${PGVERSION}/postgresql-${PGVERSION}.tar.bz2

mkdir /tmp/${PGNAME}-src
cd /tmp/${PGNAME}-src
tar xjf /tmp/postgresql-${PGVERSION}.tar.bz2 --strip-components 1 -C /tmp/${PGNAME}-src
                                                                

./configure --prefix=/tmp/${PGNAME} --
make && make install
# Required for contrib package DBLink
make -C src/backend ../../src/include/utils/fmgroids.h 
make -C contrib && make -C contrib install
cd /tmp
tar cjf ${PGNAME}.tar.bz2 ${PGNAME}



curl -u bwalding -k -T /tmp/${PGNAME}.tar.bz2 https://repository-cloudbees.forge.cloudbees.com/distributions/ci-addons/postgresql/${PGNAME}.tar.bz2
   

#mkdir -p /mnt/distributions
#mount -t davfs -o dir_mode=0770,file_mode=0770,uid=hudson,gid=hudson,conf=/home/hudson/.davfs2/davfs2.conf \
# https://repository-cloudbees.forge.cloudbees.com/distributions/ \
# /mnt/distributions
##
#cp /tmp/${PGNAME}.tar.bz2 /mnt/distributions/ci-addons/postgresql/${PGNAME}.tar.bz2
#umount /mnt/distributions